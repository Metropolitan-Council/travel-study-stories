
test_age_x_purpose <-
  create_two_way_table("age", "d_purpose_category_imputed")

expect_age_x_purpose <-
  tibble::tribble(
                             ~age,            ~d_purpose_category_imputed, ~total_N, ~total_N_hh, ~group_N, ~group_N_hh, ~expanded_total, ~expanded_total_se, ~estimated_prop, ~estimated_prop_se,
                        "Under 5",                                 "Home",   299889,        6449,     4711,         533,     199705.0281,         7120.58183,         0.35284,             0.0101,
                        "Under 5",                         "Work-related",   299889,        6449,      138,          64,      6388.44746,         1129.39173,         0.01129,            0.00199,
                        "Under 5",                               "School",   299889,        6449,      987,         249,     38272.76858,         2875.47642,         0.06762,            0.00494,
                        "Under 5",                               "Escort",   299889,        6449,     1851,         400,    105035.85485,          4998.3801,         0.18558,            0.00803,
                        "Under 5",                                 "Shop",   299889,        6449,     1870,         433,     75627.13745,         4956.93733,         0.13362,            0.00801,
                        "Under 5",                                 "Meal",   299889,        6449,     1083,         361,     34906.48618,         2880.12233,         0.06167,            0.00494,
                        "Under 5",                    "Social/Recreation",   299889,        6449,     3007,         469,      86807.3429,         4336.71409,         0.15337,            0.00716,
                        "Under 5",                         "Errand/Other",   299889,        6449,      122,          69,      7053.17414,         1713.88979,         0.01246,              0.003,
                        "Under 5",                          "Change mode",   299889,        6449,      120,          55,      4933.89715,          911.82684,         0.00872,            0.00161,
                        "Under 5", "Spent the night at non-home location",   299889,        6449,       26,          11,       810.77099,          354.54913,         0.00143,            0.00063,
                        "Under 5",                       "School-related",   299889,        6449,       81,          63,      6448.64991,         1198.67153,         0.01139,            0.00211,
                           "5-15",                                 "Home",   299889,        6449,     8620,         871,     458433.2903,        11522.84362,         0.36412,            0.00729,
                           "5-15",                         "Work-related",   299889,        6449,      319,         123,     13019.78811,         1650.88352,         0.01034,            0.00131,
                           "5-15",                               "School",   299889,        6449,     2789,         651,    210852.95267,         8310.63134,         0.16748,            0.00595,
                           "5-15",                               "Escort",   299889,        6449,     3879,         668,    219881.15167,         7378.97542,         0.17465,            0.00542,
                           "5-15",                                 "Shop",   299889,        6449,     2704,         633,     85976.40003,         4603.92041,         0.06829,            0.00355,
                           "5-15",                                 "Meal",   299889,        6449,     1883,         570,     62690.40452,         3924.45079,         0.04979,            0.00305,
                           "5-15",                    "Social/Recreation",   299889,        6449,     4451,         700,    150827.95013,         6613.27343,          0.1198,            0.00493,
                           "5-15",                         "Errand/Other",   299889,        6449,      264,         135,     30663.91382,         3764.32935,         0.02436,            0.00294,
                           "5-15",                          "Change mode",   299889,        6449,      231,          87,      9429.08139,         1704.57082,         0.00749,            0.00135,
                           "5-15", "Spent the night at non-home location",   299889,        6449,       73,          28,      2390.08298,          727.75861,          0.0019,            0.00058,
                           "5-15",                       "School-related",   299889,        6449,      216,         114,     14844.80794,         1804.13907,         0.01179,            0.00143,
                          "16-17",                                 "Home",   299889,        6449,     1082,         195,     79707.77144,         5534.27619,         0.39322,            0.02147,
                          "16-17",                                 "Work",   299889,        6449,       58,          32,      4057.19473,         1183.72913,         0.02002,            0.00579,
                          "16-17",                         "Work-related",   299889,        6449,       47,          18,      3884.65061,         1669.83443,         0.01916,            0.00812,
                          "16-17",                               "School",   299889,        6449,      462,         140,     46367.51323,         4218.75888,         0.22874,            0.01836,
                          "16-17",                               "Escort",   299889,        6449,      324,          95,     21510.43644,         2800.55683,         0.10612,            0.01313,
                          "16-17",                                 "Shop",   299889,        6449,      249,          84,     10931.94823,         1991.72781,         0.05393,            0.00958,
                          "16-17",                                 "Meal",   299889,        6449,      245,         112,     12610.45573,         2170.90997,         0.06221,            0.01039,
                          "16-17",                    "Social/Recreation",   299889,        6449,      440,         124,     15908.80202,         2598.31008,         0.07848,            0.01227,
                          "16-17",                         "Errand/Other",   299889,        6449,       42,          30,      3896.99198,         1477.34365,         0.01922,             0.0072,
                          "16-17",                          "Change mode",   299889,        6449,       15,          11,      1884.01834,         1307.44054,         0.00929,             0.0064,
                          "16-17", "Spent the night at non-home location",   299889,        6449,        9,           7,       459.40652,          269.45639,         0.00227,            0.00133,
                          "16-17",                       "School-related",   299889,        6449,       28,          13,      1487.87993,          544.76186,         0.00734,            0.00269,
                          "18-24",                                 "Home",   299889,        6449,     3332,         362,    223998.30718,         9181.46574,         0.28419,            0.00976,
                          "18-24",                                 "Work",   299889,        6449,      913,         212,     77528.29875,         5649.10796,         0.09836,            0.00676,
                          "18-24",                         "Work-related",   299889,        6449,     1009,         211,      76903.4056,         4627.35095,         0.09757,            0.00566,
                          "18-24",                               "School",   299889,        6449,      302,         100,     38813.21576,         4528.44618,         0.04924,            0.00556,
                          "18-24",                               "Escort",   299889,        6449,      687,         193,     44066.87931,         4223.45975,         0.05591,            0.00519,
                          "18-24",                                 "Shop",   299889,        6449,     1466,         283,     69832.13797,         4793.74683,          0.0886,            0.00583,
                          "18-24",                                 "Meal",   299889,        6449,     1490,         293,     81342.45861,          5424.8592,          0.1032,            0.00652,
                          "18-24",                    "Social/Recreation",   299889,        6449,     2441,         293,     97894.72114,         5359.11101,          0.1242,            0.00646,
                          "18-24",                         "Errand/Other",   299889,        6449,      208,          97,     10482.57911,         2588.23398,          0.0133,            0.00325,
                          "18-24",                          "Change mode",   299889,        6449,      495,         111,     21075.98467,         2266.55873,         0.02674,            0.00286,
                          "18-24", "Spent the night at non-home location",   299889,        6449,      205,          75,     11374.97161,         1827.19013,         0.01443,            0.00231,
                          "18-24",                       "School-related",   299889,        6449,      535,          92,     34875.63106,         3039.47951,         0.04425,             0.0038,
                          "25-34",                                 "Home",   299889,        6449,    15501,        1306,     562237.2587,        12922.77759,         0.27675,            0.00556,
                          "25-34",                                 "Work",   299889,        6449,     5529,         978,     263135.1426,         9796.09992,         0.12952,            0.00448,
                          "25-34",                         "Work-related",   299889,        6449,     5732,         930,    237322.60899,           7621.406,         0.11682,            0.00362,
                          "25-34",                               "School",   299889,        6449,      183,          65,     12160.33664,          3204.5903,         0.00599,            0.00157,
                          "25-34",                               "Escort",   299889,        6449,     3313,         716,    171240.09978,         7861.74683,         0.08429,            0.00369,
                          "25-34",                                 "Shop",   299889,        6449,     7286,        1153,    238397.99343,         9897.66628,         0.11735,            0.00453,
                          "25-34",                                 "Meal",   299889,        6449,     6096,        1098,    174266.82111,         7678.05856,         0.08578,            0.00362,
                          "25-34",                    "Social/Recreation",   299889,        6449,    10171,        1156,     260169.4889,         9746.73629,         0.12806,            0.00446,
                          "25-34",                         "Errand/Other",   299889,        6449,      598,         322,     35479.50219,         4917.51818,         0.01746,            0.00239,
                          "25-34",                          "Change mode",   299889,        6449,     2459,         461,     50416.68723,         2941.66448,         0.02482,            0.00145,
                          "25-34", "Spent the night at non-home location",   299889,        6449,      427,         149,      10626.0161,         1596.39933,         0.00523,            0.00078,
                          "25-34",                       "School-related",   299889,        6449,      361,         164,     16137.32769,         1773.51242,         0.00794,            0.00087,
                          "35-44",                                 "Home",   299889,        6449,    16452,        1360,    644169.01474,        13710.98512,         0.27972,            0.00517,
                          "35-44",                                 "Work",   299889,        6449,     5253,        1025,    273540.54955,         9795.83471,         0.11878,            0.00398,
                          "35-44",                         "Work-related",   299889,        6449,     5617,         925,    217213.62627,         7993.37218,         0.09432,            0.00332,
                          "35-44",                               "School",   299889,        6449,       64,          39,      8728.26341,         2004.93245,         0.00379,            0.00087,
                          "35-44",                               "Escort",   299889,        6449,     5818,         909,    301512.66126,          9978.9127,         0.13093,            0.00404,
                          "35-44",                                 "Shop",   299889,        6449,     7890,        1193,    253622.59696,         9387.56998,         0.11013,            0.00383,
                          "35-44",                                 "Meal",   299889,        6449,     5680,        1118,    179879.71951,         7172.52849,         0.07811,            0.00301,
                          "35-44",                    "Social/Recreation",   299889,        6449,     9755,        1180,    286985.75671,         9569.82075,         0.12462,             0.0039,
                          "35-44",                         "Errand/Other",   299889,        6449,      704,         374,     54929.22323,         6350.51221,         0.02385,            0.00271,
                          "35-44",                          "Change mode",   299889,        6449,     1767,         384,     57364.49253,          4013.8499,         0.02491,            0.00173,
                          "35-44", "Spent the night at non-home location",   299889,        6449,      351,         132,     10680.71537,          1416.3477,         0.00464,            0.00061,
                          "35-44",                       "School-related",   299889,        6449,      310,         174,     14283.22914,         1690.24305,          0.0062,            0.00073,
                          "45-54",                                 "Home",   299889,        6449,    11864,        1137,    520578.09464,        13362.51547,         0.27439,            0.00619,
                          "45-54",                                 "Work",   299889,        6449,     3744,         815,    234594.45986,        10505.24575,         0.12365,            0.00513,
                          "45-54",                         "Work-related",   299889,        6449,     4411,         728,     215606.1186,         8147.47466,         0.11364,            0.00412,
                          "45-54",                               "School",   299889,        6449,       23,          12,      7611.83551,         3245.66514,         0.00401,             0.0017,
                          "45-54",                               "Escort",   299889,        6449,     3475,         636,    189183.77923,         8391.94265,         0.09972,            0.00422,
                          "45-54",                                 "Shop",   299889,        6449,     6173,         967,    238661.70259,         9959.95706,         0.12579,             0.0049,
                          "45-54",                                 "Meal",   299889,        6449,     3919,         856,    126085.38859,         6224.21896,         0.06646,            0.00321,
                          "45-54",                    "Social/Recreation",   299889,        6449,     6830,         932,    227734.02897,         9726.59796,         0.12004,             0.0048,
                          "45-54",                         "Errand/Other",   299889,        6449,      619,         343,     78049.37827,         8095.03426,         0.04114,            0.00413,
                          "45-54",                          "Change mode",   299889,        6449,     1139,         259,     39825.22523,         4000.30311,         0.02099,            0.00209,
                          "45-54", "Spent the night at non-home location",   299889,        6449,      283,         101,     10713.48919,         1771.57443,         0.00565,            0.00093,
                          "45-54",                       "School-related",   299889,        6449,      180,          99,      8586.38657,         1587.95456,         0.00453,            0.00084,
                          "55-64",                                 "Home",   299889,        6449,    13260,        1550,    544618.80543,        14981.93861,         0.28815,            0.00689,
                          "55-64",                                 "Work",   299889,        6449,     3453,         854,    209861.97079,         9906.18919,         0.11104,            0.00495,
                          "55-64",                         "Work-related",   299889,        6449,     4405,         724,     176193.6404,         8410.81716,         0.09322,            0.00428,
                          "55-64",                               "School",   299889,        6449,       25,          15,      4519.48078,          2386.9664,         0.00239,            0.00126,
                          "55-64",                               "Escort",   299889,        6449,     2219,         640,    108283.89447,         7639.74296,         0.05729,            0.00391,
                          "55-64",                                 "Shop",   299889,        6449,     8002,        1207,    276990.76249,        11396.89349,         0.14655,            0.00558,
                          "55-64",                                 "Meal",   299889,        6449,     4450,        1010,    145958.56986,         8481.93147,         0.07723,             0.0043,
                          "55-64",                    "Social/Recreation",   299889,        6449,     8718,        1126,    210217.89199,         8690.69183,         0.11122,            0.00442,
                          "55-64",                         "Errand/Other",   299889,        6449,     1072,         556,    149472.08636,         11245.9204,         0.07908,             0.0056,
                          "55-64",                          "Change mode",   299889,        6449,     1353,         290,     47291.66129,         4675.20143,         0.02502,            0.00244,
                          "55-64", "Spent the night at non-home location",   299889,        6449,      331,         117,      9284.73917,         1545.09754,         0.00491,            0.00082,
                          "55-64",                       "School-related",   299889,        6449,      128,          84,      7349.46044,         1582.90496,         0.00389,            0.00084,
                          "65-74",                                 "Home",   299889,        6449,     8900,        1283,    348572.50164,        11499.54658,         0.27708,            0.00819,
                          "65-74",                                 "Work",   299889,        6449,      621,         215,     56874.19544,         7168.25043,         0.04521,            0.00551,
                          "65-74",                         "Work-related",   299889,        6449,     1156,         254,     48451.01014,         5320.67306,         0.03851,            0.00413,
                          "65-74",                               "School",   299889,        6449,       20,          13,      2886.81366,         1678.80355,         0.00229,            0.00133,
                          "65-74",                               "Escort",   299889,        6449,     1761,         511,     71464.66627,         5851.79378,         0.05681,            0.00452,
                          "65-74",                                 "Shop",   299889,        6449,     5996,         987,    225115.01881,        10072.31555,         0.17894,            0.00732,
                          "65-74",                                 "Meal",   299889,        6449,     2812,         742,     98531.63743,         6997.75217,         0.07832,            0.00534,
                          "65-74",                    "Social/Recreation",   299889,        6449,     6860,         896,    180178.35046,         7927.63834,         0.14322,            0.00603,
                          "65-74",                         "Errand/Other",   299889,        6449,     1282,         619,    196816.66498,        11577.35188,         0.15645,            0.00823,
                          "65-74",                          "Change mode",   299889,        6449,      504,         178,     19422.70313,         3474.67691,         0.01544,            0.00274,
                          "65-74", "Spent the night at non-home location",   299889,        6449,      239,          88,      7325.12889,         1621.40609,         0.00582,            0.00129,
                          "65-74",                       "School-related",   299889,        6449,       94,          65,      2400.32011,          695.19899,         0.00191,            0.00055,
                    "75 or older",                                 "Home",   299889,        6449,     2013,         537,    131426.52254,         7470.13482,         0.30252,            0.01486,
                    "75 or older",                                 "Work",   299889,        6449,       62,          25,      5733.73749,         1627.35589,          0.0132,            0.00372,
                    "75 or older",                         "Work-related",   299889,        6449,      227,          40,     11859.43813,         2856.54038,          0.0273,            0.00646,
                    "75 or older",                               "School",   299889,        6449,        4,           4,       311.12855,          173.51789,         0.00072,              4e-04,
                    "75 or older",                               "Escort",   299889,        6449,      392,         125,     12494.78663,         1884.97738,         0.02876,            0.00432,
                    "75 or older",                                 "Shop",   299889,        6449,     1315,         320,     78092.50319,         6665.74829,         0.17976,            0.01369,
                    "75 or older",                                 "Meal",   299889,        6449,      604,         218,     40225.48313,          4582.6837,         0.09259,            0.01002,
                    "75 or older",                    "Social/Recreation",   299889,        6449,     1357,         307,     57355.06482,         4741.01259,         0.13202,            0.01037,
                    "75 or older",                         "Errand/Other",   299889,        6449,      577,         291,     91472.12375,         7411.64083,         0.21056,            0.01479,
                    "75 or older",                          "Change mode",   299889,        6449,      102,          36,      3721.38525,          635.41056,         0.00857,            0.00148,
                    "75 or older", "Spent the night at non-home location",   299889,        6449,       62,          18,      1495.29542,          709.61725,         0.00344,            0.00163,
                    "75 or older",                       "School-related",   299889,        6449,       27,          17,       244.76565,           91.79149,         0.00056,            0.00021
                    )

purrr::map(
  names(test_age_x_purpose)[2:9],
  function(x) {
    testthat::expect_equal(test_age_x_purpose[x], expect_age_x_purpose[x])
  }
) %>%
  suppressMessages()



# Test a numeric variable - trip distance x purpose ------------
test_distance_x_purpose <-
  create_one_way_table("d_purpose_category_imputed", "distance")

expect_distance_x_purpose <-

purrr::map(
  names(test_distance_x_purpose)[2:9],
  function(x) {
    testthat::expect_equal(test_distance_x_purpose[x], expect_distance_x_purpose[x])
  }
) %>%
  suppressMessages()
